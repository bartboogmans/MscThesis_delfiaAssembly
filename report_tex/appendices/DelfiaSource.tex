% This file was automatically created from the m-file 
% "m2tex.m" written by USL. 
% The fontencoding in this file is UTF-8. 
%  
% You will need to include the following two packages in 
% your LaTeX-Main-File. 
%  
% \usepackage{color} 
% \usepackage{fancyvrb} 
%  
% It is advised to use the following option for Inputenc 
% \usepackage[utf8]{inputenc} 
%  
  
% definition of matlab colors: 
\definecolor{mblue}{rgb}{0,0,1} 
\definecolor{mgreen}{rgb}{0.13333,0.5451,0.13333} 
\definecolor{mred}{rgb}{0.62745,0.12549,0.94118} 
\definecolor{mgrey}{rgb}{0.5,0.5,0.5} 
\definecolor{mdarkgrey}{rgb}{0.25,0.25,0.25} 
  
\DefineShortVerb[fontfamily=courier,fontseries=m]{\$} 
\DefineShortVerb[fontfamily=courier,fontseries=b]{\#} 
  
\noindent                                                                                                                                                                                                                       $$\color{mblue}$classdef$\color{black}$ Delfia < Vessel & handle$\\ $$\color{mgreen}$%Delfia creates a vessel object representing RAS' Delfia-1* model.$\color{black}$$\\ $    $\color{mgreen}$%   The Delfia object encompasses major variables, parameters, functions,$\color{black}$$\\ $    $\color{mgreen}$%   and components that help various tasks related to control automation. $\color{black}$$\\ $    $\color{mgreen}$% $\color{black}$$\\ $    $\color{mgreen}$%   Purpose of this class is including, but not limited to:$\color{black}$$\\ $    $\color{mgreen}$%   - Storing vessel specific data in a structured fashion$\color{black}$$\\ $    $\color{mgreen}$%   - Support connectivity over ROS networks$\color{black}$$\\ $    $\color{mgreen}$%   - Provide Delfia-1* model specific actuator control functions$\color{black}$$\\ $    $\color{mgreen}$%   - Provide display functions$\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$%   d1 = Delfia(x,y,yaw,'delfiaName')$\color{black}$$\\ $    $\\ $    $\color{mgreen}$% (c) Bart Boogmans 2020/2021 bartboogmans@hotmail.com,$\color{black}$$\\ $    $\color{mgreen}$% You may use, distribute and modify this code under given that clear$\color{black}$$\\ $    $\color{mgreen}$% credit is given to the author's work. $\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$% Developed in cooperation with the Researchlab Autonomous Shipping$\color{black}$$\\ $    $\color{mgreen}$% Delft & Department Maritime and Transport Technology of faculty 3mE, TU Delft. $\color{black}$$\\ $    $\color{mgreen}$% https://rasdelft.nl/nl/$\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$% Changelog$\color{black}$$\\ $    $\color{mgreen}$% Last update 29/08/2021: commenting : Bart Boogmans$\color{black}$$\\ $    $\\ $    properties$\\ $        $\color{mgreen}$% Actuator states$\color{black}$$\\ $        thrAngle                    $\color{mgreen}$% [radians]     (1x2)   Angles of thrusters$\color{black}$$\\ $        thrForce                    $\color{mgreen}$% [N]           (1x2)   Estimated propulsion force of a thruster (based on ref speed)$\color{black}$$\\ $        thrSpd                      $\color{mgreen}$% [rounds/s]    (1x2)   Reference speed of thrusters$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Communication$\color{black}$$\\ $        actuation_publisher         $\color{mgreen}$% [ROS publisher]       Object for sending data to ROS topics$\color{black}$$\\ $        actuation_subscriber        $\color{mgreen}$% [ROS subscriber]      Object for subscribing to ROS topics$\color{black}$$\\ $        location_publisher$\\ $        location_subscriber$\\ $        $\\ $        $\color{mgreen}$% Multi-vessel platforming related variables$\color{black}$$\\ $        platf_eta                   $\color{mgreen}$% [m,m,radian]  (1x3)   Pose of this vessel in platform frame if it is connected$\color{black}$$\\ $$\\ $        $\color{mgreen}$% Parameters$\color{black}$$\\ $        r_thr                       $\color{mgreen}$% [m]           (2x2)   Location of thrusters in local frame$\color{black}$$\\ $        RPSmin                      $\color{mgreen}$% [rounds/s]    (1x1)   Minimum speed of azimuth propeller$\color{black}$$\\ $        RPSmax                      $\color{mgreen}$% [rounds/s]    (1x1)   Maximum speed of azimuth propeller$\color{black}$$\\ $        thrFmax                     $\color{mgreen}$% [N]           (1x1)   Maximum force of single azimuth at full power$\color{black}$$\\ $        I_z                         $\color{mgreen}$% [kg*m^2]      (1x1)   Estimated moment of inertia around z axis$\color{black}$$\\ $                $\\ $        $\color{mgreen}$% Display$\color{black}$$\\ $        plotThr                     $\color{mgreen}$% [Bool]        (1x1)   Boolean true if the thruster is to be plotted$\color{black}$$\\ $        plotF                       $\color{mgreen}$% [Bool]        (1x1)   Boolean true if thruster forces are to be plotted$\color{black}$$\\ $        forceColor                  $\color{mgreen}$% [rgb colormap](2x3)   Color of the force vectors from the thrusters$\color{black}$$\\ $        refColor                    $\color{mgreen}$% [rgb colormap](1x3)   Color of the reference$\color{black}$$\\ $        thrOutline                  $\color{mgreen}$% [double]      (2xi)   Array with data on the thruster perimeter$\color{black}$$\\ $        $\color{mblue}$for$\color{black}$ceScale                  $\color{mgreen}$% [double]      (1x1)   Scaling factor for force arrow display$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Other$\color{black}$$\\ $        nr                          $\color{mgreen}$% [integer]     (1x1)   Optional identifier to distinguish itself from other Delfia's in a system$\color{black}$$\\ $    $\color{mblue}$end$\color{black}$$\\ $$\\ $    methods$\\ $        $\color{mgreen}$% Constructor$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ obj = Delfia(x_,y_,yaw_,name_,~)$\\ $            obj = obj@Vessel();$\\ $            $\color{mblue}$if$\color{black}$ nargin > 2$\\ $                obj.x(1:3) = [x_;y_;yaw_];$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ nargin == 4$\\ $                obj.name = name_;$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\color{mgreen}$% Set parameters specific to Delfia-1* models$\color{black}$$\\ $            obj.RPSmin = 8;$\\ $            obj.RPSmax = 100;$\\ $            obj.w = 0.20;$\\ $            obj.l = 0.38;$\\ $            obj.m = 4;$\\ $            obj.r_thr = [-0.155,0;0.155,0];$\\ $            [obj.M,~,~,~] = Delfia_Model([0;0;0;0;0;0]);$\\ $            obj.thrFmax = 0.2160;         $\color{mgreen}$% [N] per thruster at ~120rps. Error is expected to be within 20%, so it's a coarse measurement aimed to determine order of magnitude, so use with caution. [BB]$\color{black}$$\\ $            $\\ $            $\color{mgreen}$% Set initial state for control related variables$\color{black}$$\\ $            obj.thrAngle = [0,0];$\\ $            obj.thrForce = [0,0];$\\ $            obj.thrSpd = [0,0];$\\ $            obj.platf_eta = [0;0;0];            $\\ $            $\\ $            $\color{mgreen}$% Initiate display settings$\color{black}$$\\ $            cf = 0.015; $\color{mgreen}$% decorative chamfer$\color{black}$$\\ $            obj.outline = [   obj.l/2      ,obj.l/2-cf   ,-obj.l/2+cf    ,-obj.l/2       ,-obj.l/2       ,-obj.l/2+cf    ,obj.l/2-cf     ,obj.l/2        ,obj.l/2 ;$\\ $                                    obj.w/2-cf   $\color{mred}$,obj.w/2      ,obj.w/2        ,obj.w/2-cf     ,-obj.w/2+cf    ,-obj.w/2       ,-obj.w/2       ,-obj.w/2+cf    ,obj.w/2-cf];                   $\color{black}$$\\ $            obj.thrOutline =   [   0.006,      -0.013,     -0.013,     -0.037,     -0.037,     -0.013,     -0.013,     0.006,      0.006;$\\ $                                        $\color{mred}$-0.0075,    -0.0075,    -0.023,     -0.020,     0.020,      0.023,      0.0075,     0.0075,     -0.0075 ];$\color{black}$$\\ $            obj.plotThr = true;$\\ $            obj.plotF = true;$\\ $            obj.forceColor = [0,1,0 ; 1,0,0];$\\ $            obj.forceScale = 2.0; $\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Destructor$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ delete(obj)$\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.actuation_publisher)$\\ $                disp(join([$\color{mred}$'Deleting '$\color{black}$,obj.name,$\color{mred}$' .actuation_publisher '$\color{black}$,obj.actuation_publisher.TopicName]))$\\ $                delete(obj.actuation_publisher)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.actuation_subscriber)$\\ $                disp(join([$\color{mred}$'Deleting '$\color{black}$,obj.name,$\color{mred}$' .actuation_subscriber '$\color{black}$,obj.actuation_subscriber.TopicName]))$\\ $                delete(obj.actuation_subscriber)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.location_publisher)$\\ $                disp(join([$\color{mred}$'Deleting '$\color{black}$,obj.name,$\color{mred}$' .actuation_publisher '$\color{black}$,obj.location_publisher.TopicName]))$\\ $                delete(obj.location_publisher)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.location_subscriber)$\\ $                disp(join([$\color{mred}$'Deleting '$\color{black}$,obj.name,$\color{mred}$' .actuation_publisher '$\color{black}$,obj.location_subscriber.TopicName]))$\\ $                delete(obj.location_subscriber)$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$%% Interaction with ROS$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ ros_sub_pose(obj,message)$\\ $            $\color{mgreen}$% Processes an update on ROS pose topic$\color{black}$$\\ $            obj.x(1) = message.Pose.Position.X; $\color{mgreen}$% Horizontal, in line with the tank (positive = away from carriage)$\color{black}$$\\ $            obj.x(2) = message.Pose.Position.Y; $\color{mgreen}$% Horizontal, perpendicular to length of tank (positive = towards walkway)$\color{black}$$\\ $            eul = euler(quaternion([message.Pose.Orientation.W,message.Pose.Orientation.X,message.Pose.Orientation.Y ,message.Pose.Orientation.Z]),$\color{mred}$'ZYX'$\color{black}$,$\color{mred}$'frame'$\color{black}$);$\\ $            obj.x(3) = eul(1); $\color{mgreen}$% Range [pi to +pi]$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mblue}$function$\color{black}$ ros_sub_actuation(obj,message)$\\ $            $\color{mgreen}$% Processes an update on ROS actuation topic$\color{black}$$\\ $            obj.thrSpd = [message.Data(1),message.Data(2)];$\\ $            obj.thrAngle = [message.Data(3),message.Data(4)];$\\ $            obj.calcThrF;$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mblue}$function$\color{black}$ ros_pub_pose(obj,time)$\\ $            $\color{mgreen}$% Publish object pose on ROS$\color{black}$$\\ $            msg = rosmessage(obj.location_publisher);$\\ $            msg.Pose.Position.X = obj.x(1);$\\ $            msg.Pose.Position.Y = obj.x(2);$\\ $            $\\ $            quat = eul2quat([obj.x(3),0,0]);$\\ $            msg.Pose.Orientation.W = quat(1);$\\ $            msg.Pose.Orientation.X = quat(2);$\\ $            msg.Pose.Orientation.Y = quat(3);$\\ $            msg.Pose.Orientation.Z = quat(4);$\\ $            $\\ $            msg.Header.Stamp.Sec = floor(time);$\\ $            msg.Header.Stamp.Nsec = floor((time - floor(time))*1000000);$\\ $            $\\ $            send(obj.location_publisher,msg)$\\ $        $\color{mblue}$end$\color{black}$$\\ $  $\\ $        $\color{mblue}$function$\color{black}$ ros_pub_actuation(obj)$\\ $            $\color{mgreen}$% Publish object actuation on ROS$\color{black}$$\\ $            msg = rosmessage(obj.actuation_publisher);$\\ $            msg.Data = [obj.thrSpd(1),obj.thrSpd(2),obj.thrAngle(1),obj.thrAngle(2)];$\\ $            send(obj.actuation_publisher,msg);$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$%% Display$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ plotVessel(obj,ax)$\\ $            $\color{mgreen}$% Displays the outline of the vessel, and thrusters and$\color{black}$$\\ $            $\color{mgreen}$% actuator forces if configured$\color{black}$$\\ $            $\\ $            R = R2d(obj.x(3));$\\ $            $\\ $            $\color{mgreen}$% Plot the hull$\color{black}$$\\ $            plotVessel@Vessel(obj,ax);$\\ $            $\\ $            $\color{mgreen}$% Plot the thrusters$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ obj.plotThr == true$\\ $                $\color{mblue}$for$\color{black}$ i= 1:length(obj.r_thr)$\\ $                    thruster_vector = R*(R2d(obj.thrAngle(i))*obj.thrOutline + obj.r_thr(i,:)') + obj.x(1:2);$\\ $                    plot(ax,thruster_vector(1,:),thruster_vector(2,:),$\color{mred}$'color'$\color{black}$,obj.color);$\\ $                $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\color{mgreen}$% plot the force vectors assigned to be applied by the thrusters$\color{black}$$\\ $            $\color{mblue}$if$\color{black}$ obj.plotF == true$\\ $                $\color{mblue}$for$\color{black}$ i= 1:length(obj.r_thr)$\\ $                    thr_pos_n = R*(obj.r_thr(i,:)') + obj.x(1:2);$\\ $                    f_n = R*(R2d(obj.thrAngle(i))*[obj.thrForce(i);0]);$\\ $                    quiver(thr_pos_n(1),thr_pos_n(2),f_n(1),f_n(2),obj.forceScale,$\color{mred}$'LineWidth'$\color{black}$,1.5,$\color{mred}$'color'$\color{black}$,obj.forceColor(i,:),$\color{mred}$'MaxHeadSize'$\color{black}$,0.4)$\\ $                $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$end$\color{black}$   $\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$%% Force and speed conversion$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ bound_motor_speeds(obj)$\\ $            $\color{mblue}$for$\color{black}$ i = 1:length(obj.r_thr)$\\ $                $\color{mblue}$if$\color{black}$ (obj.thrSpd(i) <= obj.RPSmin) && (obj.thrSpd(i) >= -obj.RPSmin)$\\ $                    obj.thrSpd(i) = 0;$\\ $                $\color{mblue}$elseif$\color{black}$ obj.thrSpd(i) >= obj.RPSmax$\\ $                    obj.thrSpd(i) = obj.RPSmax;$\\ $                $\color{mblue}$elseif$\color{black}$ obj.thrSpd(i) <= -obj.RPSmax$\\ $                    obj.thrSpd(i) = -obj.RPSmax;$\\ $                $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$end$\color{black}$       $\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mblue}$function$\color{black}$ calcThrSpd(obj)$\\ $            $\color{mgreen}$% Converts force to propeller speed and assigns it to object. This is based on coarse measurements. Use with care. [BB 3/2021]$\color{black}$$\\ $            $\color{mblue}$for$\color{black}$ i = 1:length(obj.thrForce)$\\ $                obj.thrSpd(i) = obj.thrForce(i)/0.0018;$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mblue}$function$\color{black}$ calcThrF(obj)$\\ $            $\color{mgreen}$% convert RPS to force and assigns it to object. This is based on coarse measurements. Use with care. [BB 3/2021]$\color{black}$$\\ $            $\color{mblue}$for$\color{black}$ i = 1:length(obj.thrForce)$\\ $                obj.thrForce(i) = obj.thrSpd(i)*0.0018;$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $    $\color{mblue}$end$\color{black}$$\\ $$\color{mblue}$end$\color{black}$$\\ 
  
\UndefineShortVerb{\$} 
\UndefineShortVerb{\#}