% This file was automatically created from the m-file 
% "m2tex.m" written by USL. 
% The fontencoding in this file is UTF-8. 
%  
% You will need to include the following two packages in 
% your LaTeX-Main-File. 
%  
% \usepackage{color} 
% \usepackage{fancyvrb} 
%  
% It is advised to use the following option for Inputenc 
% \usepackage[utf8]{inputenc} 
%  
  
% definition of matlab colors: 
\definecolor{mblue}{rgb}{0,0,1} 
\definecolor{mgreen}{rgb}{0.13333,0.5451,0.13333} 
\definecolor{mred}{rgb}{0.62745,0.12549,0.94118} 
\definecolor{mgrey}{rgb}{0.5,0.5,0.5} 
\definecolor{mdarkgrey}{rgb}{0.25,0.25,0.25} 
  
\DefineShortVerb[fontfamily=courier,fontseries=m]{\$} 
\DefineShortVerb[fontfamily=courier,fontseries=b]{\#} 
  
\noindent                                                                                                                                                                                                                                                                                      $$\color{mblue}$classdef$\color{black}$ FleetManager <handle$\\ $$\color{mgreen}$%FleetManager Manages and tracks a fleet of (Delfia) Vessels and controllers$\color{black}$$\\ $    $\color{mgreen}$%   This class can be assigned a set of Vessel and $\color{black}$$\\ $    $\color{mgreen}$%   MultiVesselPlatformController (MVPC) objects. Various tasks of the fleet$\color{black}$$\\ $    $\color{mgreen}$%   can be phasewise scripted in this object. $\color{black}$$\\ $    $\color{mgreen}$%   Phases can be ran through in obj.objectiveTimedFnc, which can$\color{black}$$\\ $    $\color{mgreen}$%   change phase automated or by human control$\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$%   This architecture is designed to work via middleware: Robotic$\color{black}$$\\ $    $\color{mgreen}$%   Operating System (ROS)$\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$%   Fleet control for a fleet of Delfia's implemented here consists of$\color{black}$$\\ $    $\color{mgreen}$%   1) Initialization$\color{black}$$\\ $    $\color{mgreen}$%       - Register 3 Delfias to 3 MVPC objects$\color{black}$$\\ $    $\color{mgreen}$%       - Set platform reference of MVPC's for initial positioning$\color{black}$$\\ $    $\color{mgreen}$%   2) Assembly$\color{black}$$\\ $    $\color{mgreen}$%       - Set platform reference of MVPC's for assembly$\color{black}$$\\ $    $\color{mgreen}$%       - When connected, re-assign control over modules between MVPC's$\color{black}$$\\ $    $\color{mgreen}$%           For assembly this means transfering control of Delfias from$\color{black}$$\\ $    $\color{mgreen}$%           multiple MVPC's to a single, such that a single controller$\color{black}$$\\ $    $\color{mgreen}$%           manages multiple vessels. $\color{black}$$\\ $    $\color{mgreen}$%       - Controllers (MVPC's) compute parameters to enable control for$\color{black}$$\\ $    $\color{mgreen}$%           new configurations.$\color{black}$$\\ $    $\color{mgreen}$%   3) Assembled Motion$\color{black}$$\\ $    $\color{mgreen}$%       - Assemblies perform motion to do a particular job, such as:$\color{black}$$\\ $    $\color{mgreen}$%           - Forward motion (1m step)$\color{black}$$\\ $    $\color{mgreen}$%           - Rotation (pi/2 rad step)$\color{black}$$\\ $    $\color{mgreen}$%           - Sideways motion (0.5m step)$\color{black}$$\\ $$\\ $    $\color{mgreen}$% (c) Bart Boogmans 2020/2021 bartboogmans@hotmail.com,$\color{black}$$\\ $    $\color{mgreen}$% You may use, distribute and modify this code under given that clear$\color{black}$$\\ $    $\color{mgreen}$% credit is given to the author's work. $\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$% Developed in cooperation with the Researchlab Autonomous Shipping$\color{black}$$\\ $    $\color{mgreen}$% Delft & Department Maritime and Transport Technology of faculty 3mE, TU Delft. $\color{black}$$\\ $    $\color{mgreen}$% https://rasdelft.nl/nl/$\color{black}$$\\ $    $\color{mgreen}$%$\color{black}$$\\ $    $\color{mgreen}$% Changelog$\color{black}$$\\ $    $\color{mgreen}$% Last update 29/08/2021: commenting : Bart Boogmans$\color{black}$$\\ $    $\\ $    properties$\\ $        node$\\ $        fleet$\\ $        controllers$\\ $        objectiveTimer$\\ $        objectiveTic$\\ $        phase$\\ $        phaseTic$\\ $        singleDelfiaInertia$\\ $        singleDelfiaMass$\\ $        singleDelfiaMaxForce$\\ $        singleDelfiaMaxTorque$\\ $    $\color{mblue}$end$\color{black}$$\\ $    $\\ $    methods$\\ $        $\\ $        $\color{mgreen}$% Constructor$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ obj = FleetManager()$\\ $        $\color{mgreen}$%FleetManager() Construct an instance of this class$\color{black}$$\\ $            obj.phase = -1; $\\ $            obj.phaseTic = tic;$\\ $            settings = delfiaSettings();$\\ $            obj.node = ros.Node($\color{mred}$'objective_planning_node'$\color{black}$,settings.hostname,$\color{mred}$'NodeHost'$\color{black}$,settings.myIP);$\\ $            $\\ $            $\\ $            $\color{mgreen}$% Create vessel objects$\color{black}$$\\ $            obj.fleet = Delfia.empty;$\\ $            $\color{mblue}$for$\color{black}$ i = 1:settings.n_vessels$\\ $                obj.fleet(i) = Delfia(0,0,0,settings.vesselnames{i});$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\color{mgreen}$% Create controller objects$\color{black}$$\\ $            obj.controllers = MultiVesselPlatformController.empty;$\\ $            $\color{mblue}$for$\color{black}$ i = 1:settings.n_vessels$\\ $                obj.controllers(i) = MultiVesselPlatformController(0, 0, 0, settings.controllerNames{i});$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\\ $            $\color{mgreen}$% Configure ROS settings of vessel and controller objects$\color{black}$$\\ $            $\color{mblue}$for$\color{black}$ i = 1:settings.n_vessels$\\ $                obj.controllers(i).node = ros.Node(obj.controllers(i).name,settings.hostname,$\color{mred}$'NodeHost'$\color{black}$,settings.myIP);$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$for$\color{black}$ i = 1:settings.n_vessels$\\ $                obj.controllers(i).refPub = ros.Publisher(obj.controllers(i).node,settings.topicnames.platformReference{i},settings.messageTypes.platformReference);$\\ $                obj.controllers(i).refSub = ros.Subscriber(obj.controllers(i).node,settings.topicnames.platformReference{i},settings.messageTypes.platformReference,{@obj.ros_sub_ref,obj.controllers(i)});$\\ $            $\color{mblue}$end$\color{black}$$\\ $$\\ $            $\color{mgreen}$% Initiate timer object that supports control phase transition$\color{black}$$\\ $            obj.objectiveTic = tic;$\\ $            obj.objectiveTimer = timer(...$\\ $                $\color{mred}$'ExecutionMode'$\color{black}$, $\color{mred}$'fixedRate'$\color{black}$,$\color{mblue}$ ...$\color{black}$$\\ $                $\color{mred}$'Period'$\color{black}$, (1),$\color{mblue}$ ...$\color{black}$$\\ $                $\color{mred}$'BusyMode'$\color{black}$, $\color{mred}$'drop'$\color{black}$,...$\\ $                $\color{mred}$'TimerFcn'$\color{black}$, $\color{mred}${@obj.objectiveTimedFnc},...$\color{black}$$\\ $                $\color{mred}$'Name'$\color{black}$, $\color{mred}$'objectiveTimer'$\color{black}$ );$\\ $            start(obj.objectiveTimer);$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Destructor$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ delete(obj)$\\ $            $\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.objectiveTimer)$\\ $                delete(obj.objectiveTimer)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            obj.stopvessels();$\\ $            $\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.node)$\\ $                delete(obj.node)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.fleet)$\\ $                delete(obj.fleet)$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\\ $            $\color{mblue}$if$\color{black}$ ~isempty(obj.controllers)$\\ $                delete(obj.controllers)$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Phasewise fleet behavior$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ objectiveTimedFnc(obj,~,~,~,~,~)$\\ $            $\color{mgreen}$% This function is called repetitively by this class' timer$\color{black}$$\\ $            $\color{mgreen}$% object. It runs commands from the current phase. Phase $\color{black}$$\\ $            $\color{mgreen}$% transition can be done manually, or by implementing checks $\color{black}$$\\ $            $\color{mgreen}$% to advance to another. $\color{black}$$\\ $            $\\ $            $\color{mblue}$switch$\color{black}$ obj.phase$\\ $                $\\ $                $\color{mblue}$case$\color{black}$ 0$\\ $                    settings  = delfiaSettings();$\\ $                    $\color{mgreen}$% Initiation$\color{black}$$\\ $                    $\color{mgreen}$% Set up initial configuration: All vessels are operating alone$\color{black}$$\\ $                    $\color{mblue}$for$\color{black}$ i = 1:settings.n_vessels$\\ $                        obj.controllers(i).attachBody(obj.fleet(i));$\\ $                        obj.controllers(i).initiateControlParameterBroadcast();$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                    $\color{mgreen}$% Wait for user input. $\color{black}$$\\ $                    obj.phaseTic = tic;$\\ $                    obj.phase = -1;$\\ $                    $\\ $                $\color{mblue}$case$\color{black}$ 1  $\\ $                    $\color{mgreen}$% Set individual vessel starting position to align for$\color{black}$$\\ $                    $\color{mgreen}$% assembly$\color{black}$$\\ $                    obj.controllers(1).x_r = [0,-0.75,0,0,0,0];$\\ $                    obj.controllers(1).ros_pub_ref();$\\ $                    obj.controllers(2).x_r = [0,0,0,0,0,0];$\\ $                    obj.controllers(2).ros_pub_ref();$\\ $                    obj.controllers(3).x_r = [0,0.75,0,0,0,0];$\\ $                    obj.controllers(3).ros_pub_ref();$\\ $                    $\\ $                    if(toc(obj.phaseTic)>=100)$\\ $                        obj.phase = obj.phase+1;$\\ $                        obj.phaseTic = tic;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                    $\\ $                $\color{mblue}$case$\color{black}$ 2$\\ $                    $\color{mgreen}$% First phase of assembly. Vessels approach one-another$\color{black}$$\\ $                    $\color{mgreen}$% to docking position.$\color{black}$$\\ $                    obj.controllers(1).x_r = [0,-0.1,0,0,0,0];$\\ $                    obj.controllers(1).ros_pub_ref();$\\ $                    obj.controllers(3).x_r = [0,0.1,0,0,0,0];$\\ $                    obj.controllers(3).ros_pub_ref();$\\ $                    $\\ $                $\color{mblue}$case$\color{black}$ 3$\\ $                    $\color{mgreen}$% Optional: Temporarily increase controller gains to $\color{black}$$\\ $                    $\color{mgreen}$% increase normal forces, to aid proper assembly.$\color{black}$$\\ $                    $\color{mblue}$for$\color{black}$ n = 1:3$\\ $                        obj.controllers(n).PIDs(1).Kp = obj.controllers(n).PIDs(1).Kp *2;$\\ $                        obj.controllers(n).PIDs(2).Kp = obj.controllers(n).PIDs(2).Kp *2;$\\ $                        obj.controllers(n).PIDs(3).Kp = obj.controllers(n).PIDs(3).Kp *2;$\\ $                    $\color{mblue}$end$\color{black}$     $\\ $                    $\\ $                $\color{mblue}$case$\color{black}$ 4$\\ $                    $\color{mgreen}$% If succesful assembly is registered or manually$\color{black}$$\\ $                    $\color{mgreen}$% observed: Register succesful connection:$\color{black}$$\\ $                    $\color{mgreen}$% Connect Delfia 1 & 3 to Delfia 2 (& thus to$\color{black}$$\\ $                    $\color{mgreen}$% controller 2)$\color{black}$$\\ $                    $\\ $                    obj.controllers(1).detatchBody(1);$\\ $                    obj.controllers(3).detatchBody(1);$\\ $                    $\\ $                    obj.fleet(1).platf_eta=[0;-obj.fleet(1).w;0];$\\ $                    obj.fleet(2).platf_eta=[0;0;0];$\\ $                    obj.fleet(3).platf_eta=[0;obj.fleet(3).w;0];$\\ $                    $\\ $                    obj.controllers(2).attachBody(obj.fleet(1));$\\ $                    obj.controllers(2).attachBody(obj.fleet(3));$\\ $                    $\\ $                    $\color{mgreen}$% This automatically triggers adjusting control$\color{black}$$\\ $                    $\color{mgreen}$% protocol$\color{black}$$\\ $                    obj.phase = 5;$\\ $                    obj.phaseTic = tic;$\\ $                $\color{mblue}$case$\color{black}$ 5$\\ $                    $\color{mgreen}$% Pause after assembly$\color{black}$$\\ $                    obj.controllers(2).x_r = [0,0,0,0,0,0];$\\ $                    obj.controllers(2).ros_pub_ref();$\\ $                    if(toc(obj.phaseTic)>=100)$\\ $                        obj.phase = obj.phase+1;$\\ $                        obj.phaseTic = tic;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                $\color{mblue}$case$\color{black}$ 6$\\ $                    $\color{mgreen}$% 1m forward motion$\color{black}$$\\ $                    obj.controllers(2).x_r = [1,0,0,0,0,0];$\\ $                    obj.controllers(2).ros_pub_ref();$\\ $                    if(toc(obj.phaseTic)>=100)$\\ $                        obj.phase = obj.phase+1;$\\ $                        obj.phaseTic = tic;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                $\color{mblue}$case$\color{black}$ 7$\\ $                    $\color{mgreen}$% 90deg rotation$\color{black}$$\\ $                    obj.controllers(2).x_r = [1,0,pi/2,0,0,0];$\\ $                    obj.controllers(2).ros_pub_ref();$\\ $                    if(toc(obj.phaseTic)>=100)$\\ $                        obj.phase = obj.phase+1;$\\ $                        obj.phaseTic = tic;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                $\color{mblue}$case$\color{black}$ 8$\\ $                    $\color{mgreen}$% 0.5m sideways motion$\color{black}$$\\ $                    obj.controllers(2).x_r = [1.5,0,pi/2,0,0,0];$\\ $                    obj.controllers(2).ros_pub_ref();$\\ $                    if(toc(obj.phaseTic)>=100)$\\ $                        obj.phase = obj.phase+1;$\\ $                        obj.phaseTic = tic;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $                    $\color{mblue}$end$\color{black}$$\\ $                $\color{mblue}$case$\color{black}$ 9$\\ $                    $\color{mgreen}$% Return to initial position of motion test$\color{black}$$\\ $                        obj.phase = 5;$\\ $                        disp(join([$\color{mred}$'Going to phase: '$\color{black}$,string(obj.phase)]))$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Register reference change of control objects$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ ros_sub_ref(~,~,message,controller)$\\ $            controller.ros_sub_ref(message);$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Stop object functionality $\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ stop(obj)$\\ $            $\color{mblue}$try$\color{black}$$\\ $                stop(obj.objectiveTimer);$\\ $            $\color{mblue}$catch$\color{black}$$\\ $                disp($\color{mred}$'Warning: could not stop ObjectivePlanner.objectiveTimer'$\color{black}$);$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$try$\color{black}$$\\ $                delete(obj.objectiveTimer);$\\ $            $\color{mblue}$catch$\color{black}$$\\ $                disp($\color{mred}$'Warning: could not delete ObjectivePlanner.objectiveTimer'$\color{black}$);$\\ $            $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$try$\color{black}$$\\ $                delete(obj.node);$\\ $            $\color{mblue}$catch$\color{black}$$\\ $                disp($\color{mred}$'Warning: could not delete ObjectivePlanner.node'$\color{black}$);$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $        $\\ $        $\color{mgreen}$% Halt actuation of entire fleet$\color{black}$$\\ $        $\color{mblue}$function$\color{black}$ stopvessels(obj)$\\ $            $\color{mblue}$for$\color{black}$ vessel = obj.fleet$\\ $                $\color{mblue}$try$\color{black}$$\\ $                    vessel.thrAngle = [0;0];$\\ $                    vessel.thrSpd = [0;0];$\\ $                    vessel.thrForce = [0;0];$\\ $                    vessel.ros_pub_actuation();$\\ $                $\color{mblue}$catch$\color{black}$$\\ $                    $\\ $                $\color{mblue}$end$\color{black}$$\\ $            $\color{mblue}$end$\color{black}$$\\ $        $\color{mblue}$end$\color{black}$$\\ $    $\color{mblue}$end$\color{black}$$\\ $$\color{mblue}$end$\color{black}$$\\ $$\\ 
  
\UndefineShortVerb{\$} 
\UndefineShortVerb{\#}